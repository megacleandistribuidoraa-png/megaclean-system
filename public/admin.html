<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#0aa04e" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<link rel="manifest" href="/manifest.json" />
<link rel="icon" type="image/svg+xml" href="/icon.svg" />
<title>Painel Admin - MegaClean</title>
<style>
:root{
  --bg:#f4f7fb;
  --card:#fff;
  --primary:#0aa04e;
  --primary-light:#e6f9ee;
  --primary-600:#0a8a44;
  --muted:#6b7280;
  --danger:#dc2626;
  --danger-light:#fef2f2;
  --warning:#f59e0b;
  --warning-light:#fffbeb;
  --info:#3b82f6;
  --info-light:#eff6ff;
  --purple:#8b5cf6;
  --purple-light:#f5f3ff;
  --radius:12px;
  --shadow: 0 8px 24px rgba(12,20,30,0.06);
  --text:#0f172a;
}
[data-theme="dark"]{
  --bg:#0f172a;
  --card:#1e293b;
  --primary:#10b981;
  --primary-light:#064e3b;
  --primary-600:#059669;
  --muted:#94a3b8;
  --danger:#f87171;
  --danger-light:#450a0a;
  --warning:#fbbf24;
  --warning-light:#422006;
  --info:#60a5fa;
  --info-light:#1e3a5f;
  --purple:#a78bfa;
  --purple-light:#2e1065;
  --shadow: 0 8px 24px rgba(0,0,0,0.3);
  --text:#e2e8f0;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: 'Segoe UI', Roboto, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  transition:background .3s,color .3s;
}

/* Header */
.header{
  background:linear-gradient(135deg, #0aa04e 0%, #059669 100%);
  padding:20px 30px;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:space-between;
  flex-wrap:wrap;
  gap:16px;
}
.header-left{
  display:flex;
  align-items:center;
  gap:16px;
}
.logo{
  font-size:32px;
}
.brand h1{
  margin:0;
  font-size:22px;
  font-weight:700;
}
.brand p{
  margin:4px 0 0;
  font-size:13px;
  opacity:0.9;
}
.header-right{
  display:flex;
  align-items:center;
  gap:12px;
}
.user-info{
  text-align:right;
}
.user-info .name{
  font-weight:600;
  font-size:14px;
}
.user-info .role{
  font-size:12px;
  opacity:0.85;
  display:flex;
  align-items:center;
  gap:4px;
  justify-content:flex-end;
}
.header-buttons{display:flex;gap:8px}
.btn-header{
  background:rgba(255,255,255,0.15);
  color:#fff;
  border:1px solid rgba(255,255,255,0.3);
  padding:10px 16px;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  font-size:13px;
  transition:all .2s;
  display:flex;
  align-items:center;
  gap:6px;
  text-decoration:none;
}
.btn-header:hover{
  background:rgba(255,255,255,0.25);
}

/* Container principal */
.container{
  max-width:1300px;
  margin:0 auto;
  padding:24px;
}

/* Cards de estat√≠sticas */
.stats-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:16px;
  margin-bottom:24px;
}
.stat-card{
  background:var(--card);
  border-radius:var(--radius);
  padding:22px;
  box-shadow:var(--shadow);
  display:flex;
  align-items:center;
  gap:16px;
  transition:transform .2s, box-shadow .2s;
  cursor:pointer;
  text-decoration:none;
  color:inherit;
}
.stat-card:hover{
  transform:translateY(-4px);
  box-shadow:0 12px 30px rgba(12,20,30,0.12);
}
.stat-icon{
  width:56px;
  height:56px;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
}
.stat-icon.green{background:var(--primary-light);color:var(--primary)}
.stat-icon.blue{background:var(--info-light);color:var(--info)}
.stat-icon.purple{background:var(--purple-light);color:var(--purple)}
.stat-icon.yellow{background:var(--warning-light);color:var(--warning)}
.stat-info h3{
  margin:0;
  font-size:28px;
  font-weight:800;
  color:#0f172a;
}
.stat-info p{
  margin:4px 0 0;
  color:var(--muted);
  font-size:13px;
}

/* Grid de conte√∫do */
.content-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}

/* Card base */
.card{
  background:var(--card);
  border-radius:var(--radius);
  padding:24px;
  box-shadow:var(--shadow);
}
.card-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:20px;
}
.card-title{
  font-size:18px;
  font-weight:700;
  margin:0;
  display:flex;
  align-items:center;
  gap:10px;
}

/* Menu de navega√ß√£o */
.nav-menu{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.nav-item{
  display:flex;
  align-items:center;
  gap:14px;
  padding:16px 18px;
  border-radius:10px;
  background:#f8fafc;
  text-decoration:none;
  color:#0f172a;
  transition:all .2s;
  border:2px solid transparent;
}
.nav-item:hover{
  background:var(--primary-light);
  border-color:var(--primary);
  transform:translateX(4px);
}
.nav-item .icon{
  width:44px;
  height:44px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  background:#fff;
  box-shadow:0 2px 8px rgba(0,0,0,0.06);
}
.nav-item .text h4{
  margin:0;
  font-size:15px;
  font-weight:600;
}
.nav-item .text p{
  margin:3px 0 0;
  font-size:12px;
  color:var(--muted);
}
.nav-item .arrow{
  margin-left:auto;
  color:var(--muted);
  font-size:18px;
}

/* Se√ß√£o admin only */
.admin-section{
  margin-top:16px;
  padding-top:16px;
  border-top:2px solid #f0f3f7;
}
.admin-section-title{
  font-size:12px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:1px;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  gap:6px;
}

/* Info cards */
.info-list{
  display:flex;
  flex-direction:column;
  gap:14px;
}
.info-item{
  display:flex;
  align-items:flex-start;
  gap:12px;
  padding:14px;
  background:#f8fafc;
  border-radius:10px;
}
.info-item .icon{
  width:36px;
  height:36px;
  border-radius:8px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:16px;
  background:var(--primary-light);
  color:var(--primary);
  flex-shrink:0;
}
.info-item .text h5{
  margin:0;
  font-size:14px;
  font-weight:600;
}
.info-item .text p{
  margin:4px 0 0;
  font-size:12px;
  color:var(--muted);
  line-height:1.5;
}

/* Badge */
.badge{
  display:inline-flex;
  padding:4px 10px;
  border-radius:20px;
  font-size:11px;
  font-weight:600;
}
.badge.admin{background:var(--purple-light);color:var(--purple)}
.badge.operador{background:var(--info-light);color:var(--info)}

/* Responsivo */
@media (max-width:1100px){
  .stats-grid{grid-template-columns:repeat(2,1fr)}
}
@media (max-width:768px){
  .header{padding:12px 16px;flex-direction:column;align-items:stretch;gap:12px}
  .header-left{justify-content:center}
  .header-right{justify-content:center;flex-wrap:wrap}
  .brand h1{font-size:18px}
  .brand p{font-size:11px}
  .logo{font-size:26px}
  .container{padding:12px}
  .stats-grid{grid-template-columns:1fr;gap:10px}
  .content-grid{grid-template-columns:1fr}
  .stat-card{padding:14px;gap:10px}
  .stat-card .icon{width:44px;height:44px;font-size:20px}
  .stat-info h3{font-size:20px}
  .stat-info p{font-size:11px}
  .user-info{display:none}
  .btn-header{padding:8px 12px;font-size:12px}
  .nav-item{padding:12px}
  .nav-item h4{font-size:14px}
  .nav-item p{font-size:11px}
  .section-title{font-size:13px;margin:16px 0 10px}
}
@media (max-width:480px){
  .header-buttons{gap:6px}
  .btn-header{padding:6px 10px;font-size:11px}
  .stats-grid{gap:8px}
  .stat-card{padding:12px}
  .stat-card .icon{width:38px;height:38px;font-size:18px;border-radius:10px}
  .stat-info h3{font-size:18px}
}
</style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="logo">üßπ</div>
      <div class="brand">
        <h1>MegaClean</h1>
        <p>Painel Administrativo</p>
      </div>
    </div>
    <div class="header-right">
      <div class="user-info">
        <div class="name" id="admin-name">Administrador</div>
        <div class="role">
          <span id="admin-role-badge">üëë</span>
          <span id="admin-role">Admin</span>
        </div>
      </div>
      <div class="header-buttons">
        <button class="btn-header" id="btn-notif" onclick="mostrarNotificacoes()" style="position:relative">
          üîî
          <span id="notif-badge" style="display:none;position:absolute;top:-4px;right:-4px;background:#dc2626;color:#fff;font-size:10px;min-width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center">0</span>
        </button>
        <button class="btn-header" id="btn-theme" onclick="toggleTheme()">üåô</button>
        <a href="/config.html" class="btn-header">‚öôÔ∏è</a>
        <button class="btn-header" id="btn-logout">Sair ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- Painel de Notifica√ß√µes -->
  <div id="notif-panel" style="display:none;position:fixed;top:70px;right:20px;width:320px;max-height:400px;background:var(--card);border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);z-index:1000;overflow:hidden">
    <div style="padding:16px;border-bottom:1px solid #e5e7eb;display:flex;justify-content:space-between;align-items:center">
      <h4 style="margin:0;font-size:16px">üîî Notifica√ß√µes</h4>
      <button onclick="fecharNotificacoes()" style="background:none;border:none;cursor:pointer;font-size:18px">‚úï</button>
    </div>
    <div id="notif-list" style="max-height:300px;overflow-y:auto;padding:8px"></div>
  </div>

  <div class="container">
    <!-- Cards de estat√≠sticas -->
    <div class="stats-grid">
      <a href="/clientes.html" class="stat-card">
        <div class="stat-icon green">üë•</div>
        <div class="stat-info">
          <h3 id="count-clients">‚Äî</h3>
          <p>Clientes cadastrados</p>
        </div>
      </a>
      <a href="/produtos.html" class="stat-card" id="card-produtos">
        <div class="stat-icon blue">üì¶</div>
        <div class="stat-info">
          <h3 id="count-products">‚Äî</h3>
          <p>Produtos no cat√°logo</p>
        </div>
      </a>
      <a href="/pedidos.html" class="stat-card">
        <div class="stat-icon purple">üõí</div>
        <div class="stat-info">
          <h3 id="count-orders">‚Äî</h3>
          <p>Pedidos realizados</p>
        </div>
      </a>
      <a href="/estoque.html" class="stat-card" id="card-estoque">
        <div class="stat-icon yellow">‚ö†Ô∏è</div>
        <div class="stat-info">
          <h3 id="count-lowstock">‚Äî</h3>
          <p>Produtos em baixa</p>
        </div>
      </a>
    </div>

    <!-- Grid de conte√∫do -->
    <div class="content-grid">
      <!-- Menu de navega√ß√£o -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìã Menu Principal</h2>
        </div>
        <nav class="nav-menu" id="nav-menu">
          <!-- Itens inseridos via JS baseado no role -->
        </nav>

        <!-- Se√ß√£o admin -->
        <div class="admin-section" id="admin-section" style="display:none">
          <div class="admin-section-title">üëë √Årea do Administrador</div>
          <nav class="nav-menu" id="admin-menu">
            <!-- Itens admin inseridos via JS -->
          </nav>
        </div>
      </div>

      <!-- Informa√ß√µes -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">‚ÑπÔ∏è Informa√ß√µes</h2>
        </div>
        <div class="info-list">
          <div class="info-item">
            <div class="icon">üöÄ</div>
            <div class="text">
              <h5>Sistema MegaClean</h5>
              <p>Sistema completo para gest√£o de produtos de limpeza, clientes e pedidos.</p>
            </div>
          </div>
          <div class="info-item">
            <div class="icon">üìä</div>
            <div class="text">
              <h5>Estoque Autom√°tico</h5>
              <p>O estoque √© atualizado automaticamente quando pedidos s√£o realizados.</p>
            </div>
          </div>
          <div class="info-item" id="info-admin" style="display:none">
            <div class="icon">üëë</div>
            <div class="text">
              <h5>Acesso Administrador</h5>
              <p>Voc√™ tem acesso total ao sistema, incluindo relat√≥rios e gerenciamento de usu√°rios.</p>
            </div>
          </div>
          <div class="info-item" id="info-operador" style="display:none">
            <div class="icon">üë§</div>
            <div class="text">
              <h5>Acesso Operador</h5>
              <p>Voc√™ tem acesso a Clientes e Pedidos. Para mais permiss√µes, contate o administrador.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// Tema escuro
function toggleTheme() {
  const html = document.documentElement;
  const isDark = html.getAttribute('data-theme') === 'dark';
  html.setAttribute('data-theme', isDark ? '' : 'dark');
  localStorage.setItem('theme', isDark ? '' : 'dark');
  document.getElementById('btn-theme').textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
}
// Carregar tema salvo
if (localStorage.getItem('theme') === 'dark') {
  document.documentElement.setAttribute('data-theme', 'dark');
  setTimeout(() => document.getElementById('btn-theme').textContent = '‚òÄÔ∏è', 0);
}

// Verificar autentica√ß√£o
const token = localStorage.getItem('admin_token');
const adminName = localStorage.getItem('admin_name') || 'Usu√°rio';
const adminRole = localStorage.getItem('admin_role') || 'admin';

if (!token) {
  window.location.href = '/index.html';
}

// Atualizar header
document.getElementById('admin-name').textContent = adminName;

const isAdmin = adminRole === 'admin';
document.getElementById('admin-role').textContent = isAdmin ? 'Administrador' : 'Operador';
document.getElementById('admin-role-badge').textContent = isAdmin ? 'üëë' : 'üë§';

// Mostrar info baseado no role
document.getElementById('info-admin').style.display = isAdmin ? 'flex' : 'none';
document.getElementById('info-operador').style.display = isAdmin ? 'none' : 'flex';

// Esconder cards de admin para operador
if (!isAdmin) {
  document.getElementById('card-produtos').style.display = 'none';
  document.getElementById('card-estoque').style.display = 'none';
  document.querySelector('.stats-grid').style.gridTemplateColumns = 'repeat(2, 1fr)';
}

// Logout
document.getElementById('btn-logout').addEventListener('click', async () => {
  try {
    await fetch('/api/logout', {
      method: 'POST',
      headers: { 'x-auth-token': token }
    });
  } catch (e) {}
  
  localStorage.removeItem('admin_token');
  localStorage.removeItem('admin_name');
  localStorage.removeItem('admin_role');
  window.location.href = '/index.html';
});

// Carregar menu baseado no role
async function carregarMenu() {
  try {
    const res = await fetch('/api/admin/pages', {
      headers: { 'x-auth-token': token }
    });
    
    if (!res.ok) throw new Error('Erro');
    
    const data = await res.json();
    const pages = data.pages || [];
    
    const navMenu = document.getElementById('nav-menu');
    const adminMenu = document.getElementById('admin-menu');
    const adminSection = document.getElementById('admin-section');
    
    // P√°ginas principais (para todos)
    const mainPages = pages.filter(p => ['dashboard', 'clientes', 'pedidos', 'orcamentos'].includes(p.id));
    
    // P√°ginas de admin
    const adminPages = pages.filter(p => ['produtos', 'categorias', 'estoque', 'fornecedores', 'contas', 'relatorio', 'solicitacoes', 'usuarios', 'config'].includes(p.id));
    
    navMenu.innerHTML = mainPages.map(p => `
      <a href="${p.url}" class="nav-item">
        <div class="icon">${p.icon || 'üìÑ'}</div>
        <div class="text">
          <h4>${p.title}</h4>
          <p>${getPageDescription(p.id)}</p>
        </div>
        <span class="arrow">‚Üí</span>
      </a>
    `).join('');
    
    if (isAdmin && adminPages.length > 0) {
      adminSection.style.display = 'block';
      adminMenu.innerHTML = adminPages.map(p => `
        <a href="${p.url}" class="nav-item">
          <div class="icon">${p.icon || 'üìÑ'}</div>
          <div class="text">
            <h4>${p.title}</h4>
            <p>${getPageDescription(p.id)}</p>
          </div>
          <span class="arrow">‚Üí</span>
        </a>
      `).join('');
    }
  } catch (e) {
    console.error(e);
    // Fallback menu
    document.getElementById('nav-menu').innerHTML = `
      <a href="/clientes.html" class="nav-item">
        <div class="icon">üë•</div>
        <div class="text"><h4>Clientes</h4><p>Cadastre e gerencie clientes</p></div>
        <span class="arrow">‚Üí</span>
      </a>
      <a href="/pedidos.html" class="nav-item">
        <div class="icon">üõí</div>
        <div class="text"><h4>Pedidos</h4><p>Crie e acompanhe pedidos</p></div>
        <span class="arrow">‚Üí</span>
      </a>
    `;
  }
}

function getPageDescription(id) {
  const descriptions = {
    'dashboard': 'Vis√£o geral do sistema',
    'clientes': 'Cadastre e gerencie seus clientes',
    'produtos': 'Gerencie seu cat√°logo de produtos',
    'categorias': 'Organize produtos por categoria',
    'pedidos': 'Crie e acompanhe pedidos',
    'orcamentos': 'Crie or√ßamentos para clientes',
    'contas': 'Controle de contas a receber',
    'estoque': 'Controle de estoque em tempo real',
    'fornecedores': 'Cadastre seus fornecedores',
    'relatorio': 'Relat√≥rios e m√©tricas do dia',
    'solicitacoes': 'Aprove pedidos retroativos',
    'usuarios': 'Gerencie usu√°rios do sistema',
    'config': 'Configura√ß√µes da sua conta'
  };
  return descriptions[id] || '';
}

// Carregar estat√≠sticas
async function loadStats() {
  try {
    // Clientes
    const clientesRes = await fetch('/api/clientes');
    const clientes = clientesRes.ok ? await clientesRes.json() : [];
    document.getElementById('count-clients').textContent = Array.isArray(clientes) ? clientes.length : 0;

    // Produtos (apenas admin)
    if (isAdmin) {
      const produtosRes = await fetch('/api/produtos');
      const produtos = produtosRes.ok ? await produtosRes.json() : [];
      document.getElementById('count-products').textContent = Array.isArray(produtos) ? produtos.length : 0;

      // Produtos em baixa
      if (Array.isArray(produtos)) {
        const lowStock = produtos.filter(p => p.quantidade <= (p.minimo || 0)).length;
        document.getElementById('count-lowstock').textContent = lowStock;
      }
    }

    // Pedidos
    const pedidosRes = await fetch('/api/pedidos');
    const pedidos = pedidosRes.ok ? await pedidosRes.json() : [];
    document.getElementById('count-orders').textContent = Array.isArray(pedidos) ? pedidos.length : 0;

  } catch (e) {
    console.error('Erro ao carregar estat√≠sticas:', e);
  }
}

// ============================================
// NOTIFICA√á√ïES
// ============================================
let notificacoes = [];

async function carregarNotificacoes() {
  notificacoes = [];
  
  try {
    // Verificar produtos com estoque baixo
    const prodRes = await fetch('/api/produtos');
    const produtos = await prodRes.json();
    const baixoEstoque = produtos.filter(p => p.quantidade <= 5);
    
    baixoEstoque.forEach(p => {
      notificacoes.push({
        tipo: 'warning',
        icon: '‚ö†Ô∏è',
        titulo: 'Estoque Baixo',
        msg: `${p.nome} - apenas ${p.quantidade} un.`,
        link: '/estoque.html'
      });
    });
    
    // Verificar solicita√ß√µes pendentes (admin)
    if (isAdmin) {
      const solRes = await fetch('/api/solicitacoes', { headers: { 'x-auth-token': token } });
      const solicitacoes = await solRes.json();
      const pendentes = solicitacoes.filter(s => s.status === 'pendente');
      
      if (pendentes.length > 0) {
        notificacoes.push({
          tipo: 'info',
          icon: 'üìã',
          titulo: 'Solicita√ß√µes Pendentes',
          msg: `${pendentes.length} solicita√ß√£o(√µes) aguardando`,
          link: '/solicitacoes.html'
        });
      }
    }
    
    // Atualizar badge
    const badge = document.getElementById('notif-badge');
    if (notificacoes.length > 0) {
      badge.style.display = 'flex';
      badge.textContent = notificacoes.length > 9 ? '9+' : notificacoes.length;
    } else {
      badge.style.display = 'none';
    }
  } catch (e) {
    console.error(e);
  }
}

function mostrarNotificacoes() {
  const panel = document.getElementById('notif-panel');
  const list = document.getElementById('notif-list');
  
  if (panel.style.display === 'block') {
    panel.style.display = 'none';
    return;
  }
  
  if (notificacoes.length === 0) {
    list.innerHTML = '<p style="text-align:center;padding:30px;color:var(--muted)">‚úÖ Nenhuma notifica√ß√£o</p>';
  } else {
    list.innerHTML = notificacoes.map(n => `
      <a href="${n.link}" style="display:flex;align-items:flex-start;gap:12px;padding:12px;border-radius:8px;text-decoration:none;color:inherit;background:${n.tipo==='warning'?'#fffbeb':'#eff6ff'}">
        <span style="font-size:20px">${n.icon}</span>
        <div>
          <strong style="font-size:13px">${n.titulo}</strong>
          <p style="margin:4px 0 0;font-size:12px;color:var(--muted)">${n.msg}</p>
        </div>
      </a>
    `).join('');
  }
  
  panel.style.display = 'block';
}

function fecharNotificacoes() {
  document.getElementById('notif-panel').style.display = 'none';
}

// Fechar ao clicar fora
document.addEventListener('click', (e) => {
  const panel = document.getElementById('notif-panel');
  const btn = document.getElementById('btn-notif');
  if (!panel.contains(e.target) && !btn.contains(e.target)) {
    panel.style.display = 'none';
  }
});

// Inicializar
carregarMenu();
loadStats();
carregarNotificacoes();
setInterval(carregarNotificacoes, 60000); // Atualizar a cada 1 minuto

// Bot√£o de Instalar PWA
let deferredPrompt;
const installBtn = document.createElement('button');
installBtn.id = 'install-btn';
installBtn.innerHTML = 'üì± Instalar App';
installBtn.style.cssText = 'display:none;position:fixed;bottom:20px;right:20px;background:var(--primary);color:#fff;border:none;padding:14px 20px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;box-shadow:0 4px 20px rgba(10,160,78,0.4);z-index:1000;animation:bounce 2s infinite';
document.body.appendChild(installBtn);

const pwaStyle = document.createElement('style');
pwaStyle.textContent = '@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}';
document.head.appendChild(pwaStyle);

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'block';
});

installBtn.addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  if (outcome === 'accepted') installBtn.style.display = 'none';
  deferredPrompt = null;
});

window.addEventListener('appinstalled', () => installBtn.style.display = 'none');
</script>
</body>
</html>
