<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Produtos - MegaClean</title>
<style>
:root{
  --bg:#f4f7fb;
  --card:#fff;
  --primary:#0aa04e;
  --primary-light:#e6f9ee;
  --primary-600:#0a8a44;
  --muted:#6b7280;
  --danger:#dc2626;
  --danger-light:#fef2f2;
  --warning:#f59e0b;
  --warning-light:#fffbeb;
  --info:#3b82f6;
  --info-light:#eff6ff;
  --purple:#8b5cf6;
  --purple-light:#f5f3ff;
  --radius:12px;
  --shadow: 0 8px 24px rgba(12,20,30,0.06);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: 'Segoe UI', Roboto, Arial, sans-serif;
  background:linear-gradient(180deg,#f7fafc 0%, var(--bg) 100%);
  color:#0f172a;
  padding:22px;
  min-height:100vh;
}
.container{max-width:1300px;margin:0 auto}

/* Header */
header{display:flex;align-items:center;justify-content:space-between;gap:18px;margin-bottom:22px;flex-wrap:wrap}
header h1{margin:0;color:var(--primary);font-size:28px;display:flex;align-items:center;gap:10px}
header h1 span{font-size:32px}
header p{margin:4px 0 0;color:var(--muted);font-size:14px}
.back-link{color:var(--primary);text-decoration:none;font-weight:600;display:inline-flex;align-items:center;gap:6px}
.back-link:hover{text-decoration:underline}
.header-actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap}

/* Cards de estat√≠sticas */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-bottom:22px}
.stat-card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);display:flex;align-items:center;gap:12px}
.stat-card .icon{width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px}
.stat-card .icon.green{background:var(--primary-light);color:var(--primary)}
.stat-card .icon.blue{background:var(--info-light);color:var(--info)}
.stat-card .icon.yellow{background:var(--warning-light);color:var(--warning)}
.stat-card .icon.red{background:var(--danger-light);color:var(--danger)}
.stat-card .icon.purple{background:var(--purple-light);color:var(--purple)}
.stat-card .info h3{margin:0;font-size:22px;font-weight:800}
.stat-card .info p{margin:4px 0 0;color:var(--muted);font-size:12px}

/* Tabs */
.tabs{display:flex;gap:0;margin-bottom:0;background:var(--card);border-radius:var(--radius) var(--radius) 0 0;padding:8px 8px 0;box-shadow:var(--shadow)}
.tab-btn{flex:1;padding:16px 24px;border:none;background:transparent;cursor:pointer;font-size:15px;font-weight:600;color:var(--muted);border-radius:10px 10px 0 0;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:10px}
.tab-btn:hover{background:#f8fafc;color:#0f172a}
.tab-btn.active{background:var(--primary);color:#fff}
.tab-btn.active.caixa{background:var(--purple)}
.tab-btn .badge{background:rgba(255,255,255,0.2);padding:2px 10px;border-radius:20px;font-size:12px}
.tab-btn:not(.active) .badge{background:#e6e9ef}

/* Card principal */
.card{background:var(--card);border-radius:0 0 var(--radius) var(--radius);padding:20px;box-shadow:var(--shadow);margin-bottom:18px}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:12px}
.card-title{font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px}

/* Filtros e busca */
.filters{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.search-box{position:relative}
.search-box input{padding:10px 14px 10px 38px;border-radius:10px;border:2px solid #e6e9ef;min-width:260px;font-size:14px;transition:border .2s}
.search-box input:focus{outline:none;border-color:var(--primary)}
.search-box::before{content:'üîç';position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px}

/* Bot√µes */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:10px;border:none;cursor:pointer;font-weight:600;font-size:14px;transition:all .2s}
.btn-primary{background:linear-gradient(135deg, #0aa04e 0%, #059669 100%);color:#fff;box-shadow:0 4px 14px rgba(10,160,78,0.2)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(10,160,78,0.3)}
.btn-purple{background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);color:#fff;box-shadow:0 4px 14px rgba(139,92,246,0.2)}
.btn-purple:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(139,92,246,0.3)}
.btn-ghost{background:#f8fafc;color:var(--muted);border:2px solid #e6e9ef}
.btn-ghost:hover{border-color:var(--primary);color:var(--primary)}
.btn-danger{background:var(--danger-light);color:var(--danger)}
.btn-danger:hover{background:var(--danger);color:#fff}
.btn-info{background:var(--info-light);color:var(--info)}
.btn-info:hover{background:var(--info);color:#fff}
.btn-sm{padding:8px 12px;font-size:12px}

/* Tabela */
.table-container{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:14px}
thead th{background:#f8fafc;padding:14px 12px;text-align:left;font-weight:600;color:var(--muted);border-bottom:2px solid #e6e9ef;white-space:nowrap}
tbody tr{transition:background .15s}
tbody tr:hover{background:#f8fafc}
tbody tr.lowstock{background:linear-gradient(90deg,#fef2f2 0%,#fff 50%)}
tbody td{padding:14px 12px;border-bottom:1px solid #f0f3f7;vertical-align:middle}
.margem-positiva{color:#0aa04e;font-weight:600}
.margem-negativa{color:#dc2626;font-weight:600}
.produto-info{display:flex;flex-direction:column;gap:2px}
.produto-nome{font-weight:600;color:#0f172a}
.produto-sku{font-size:12px;color:var(--muted)}
.produto-tipo{font-size:11px;padding:2px 8px;border-radius:12px;display:inline-block;margin-top:4px}
.produto-tipo.caixa{background:var(--purple-light);color:var(--purple)}
.produto-tipo.unitario{background:var(--primary-light);color:var(--primary)}

/* Badge */
.badge{display:inline-flex;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge.green{background:var(--primary-light);color:var(--primary)}
.badge.red{background:var(--danger-light);color:var(--danger)}
.badge.yellow{background:var(--warning-light);color:#b45309}
.badge.purple{background:var(--purple-light);color:var(--purple)}

/* A√ß√µes na tabela */
.table-actions{display:flex;gap:6px}

/* Empty state */
.empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-state .icon{font-size:48px;margin-bottom:12px}
.empty-state h4{margin:0 0 8px;color:#0f172a;font-size:18px}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;background:#0f172a;color:#fff;padding:14px 20px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);transform:translateY(100px);opacity:0;transition:all .3s ease;z-index:200;display:flex;align-items:center;gap:10px;font-weight:500}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{background:var(--primary)}
.toast.error{background:var(--danger)}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:none;align-items:center;justify-content:center;z-index:100;padding:20px}
.modal-backdrop.show{display:flex}
.modal{background:#fff;padding:24px;border-radius:16px;max-width:600px;width:100%;box-shadow:0 20px 60px rgba(2,6,23,0.3);animation:modalIn .25s ease;max-height:90vh;overflow-y:auto}
@keyframes modalIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
.modal h3{margin:0 0 20px;font-size:20px;display:flex;align-items:center;gap:10px}
.modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.modal .form-group{margin-bottom:0}
.modal .form-group.full{grid-column:1/-1}
.form-group label{display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:8px}
.form-group input,.form-group select{width:100%;padding:12px 14px;border:2px solid #e6e9ef;border-radius:10px;font-size:14px;transition:all .2s;background:#f8fafc}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary);background:#fff}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:24px}

/* Tipo selector */
.tipo-selector{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.tipo-option{padding:16px;border:3px solid #e6e9ef;border-radius:12px;cursor:pointer;text-align:center;transition:all .2s}
.tipo-option:hover{border-color:#ccc}
.tipo-option.active.unitario{border-color:var(--primary);background:var(--primary-light)}
.tipo-option.active.caixa{border-color:var(--purple);background:var(--purple-light)}
.tipo-option .icon{font-size:32px;margin-bottom:8px}
.tipo-option .label{font-weight:700;font-size:14px}
.tipo-option .desc{font-size:12px;color:var(--muted);margin-top:4px}

/* Responsivo */
@media (max-width:768px){
  header{flex-direction:column;align-items:flex-start}
  .header-actions{width:100%;flex-direction:column}
  .header-actions .btn{width:100%}
  .filters{width:100%}
  .search-box{width:100%}
  .search-box input{width:100%;min-width:auto}
  .modal-grid{grid-template-columns:1fr}
  .tabs{flex-direction:column;padding:8px}
  .tab-btn{border-radius:10px}
  .stats-grid{grid-template-columns:1fr 1fr}
}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <a href="/admin.html" class="back-link">‚Üê Voltar ao painel</a>
        <h1><span>üì¶</span> Produtos</h1>
        <p>Gerencie seu cat√°logo de produtos (Unit√°rios e Caixas)</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-ghost" onclick="abrirRelatorio()">üìä Relat√≥rio de Lucros</button>
        <button class="btn btn-primary" onclick="abrirModalNovo('unitario')">
          üìÑ Novo Unit√°rio
        </button>
        <button class="btn btn-purple" onclick="abrirModalNovo('caixa')">
          üì¶ Nova Caixa
        </button>
      </div>
    </header>

    <!-- Cards de estat√≠sticas -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="icon green">üìÑ</div>
        <div class="info">
          <h3 id="stat-unitarios">0</h3>
          <p>Produtos Unit√°rios</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="icon purple">üì¶</div>
        <div class="info">
          <h3 id="stat-caixas">0</h3>
          <p>Caixas Fechadas</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="icon blue">üí∞</div>
        <div class="info">
          <h3 id="stat-valor">R$ 0</h3>
          <p>Valor em estoque</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="icon yellow">‚ö†Ô∏è</div>
        <div class="info">
          <h3 id="stat-baixo">0</h3>
          <p>Estoque baixo</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="icon green">üìà</div>
        <div class="info">
          <h3 id="stat-lucro">R$ 0</h3>
          <p>Lucro Estimado</p>
        </div>
      </div>
    </div>

    <!-- Abas -->
    <div class="tabs">
      <button class="tab-btn active" data-tipo="unitario" onclick="mudarAba('unitario')">
        üìÑ Produtos Unit√°rios
        <span class="badge" id="count-unitarios">0</span>
      </button>
      <button class="tab-btn caixa" data-tipo="caixa" onclick="mudarAba('caixa')">
        üì¶ Caixas Fechadas
        <span class="badge" id="count-caixas">0</span>
      </button>
    </div>

    <!-- Tabela de produtos -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title" id="titulo-lista">üìÑ Produtos Unit√°rios</h2>
        <div class="filters">
          <div class="search-box">
            <input type="text" id="search" placeholder="Buscar por nome ou SKU..." />
          </div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Produto</th>
              <th>SKU</th>
              <th id="col-qtd-caixa" style="display:none">Qtd/Cx</th>
              <th>Custo</th>
              <th>Venda</th>
              <th>Lucro</th>
              <th>Margem</th>
              <th>Estoque</th>
              <th>Status</th>
              <th style="text-align:center">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr>
              <td colspan="10" class="empty-state">
                <div class="icon">üì¶</div>
                <h4>Carregando produtos...</h4>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Novo/Editar Produto -->
  <div id="modal-produto" class="modal-backdrop">
    <div class="modal">
      <h3 id="modal-title">‚ûï Novo Produto</h3>
      
      <!-- Seletor de Tipo -->
      <div class="tipo-selector" id="tipo-selector">
        <div class="tipo-option unitario" onclick="selecionarTipo('unitario')">
          <div class="icon">üìÑ</div>
          <div class="label">Unit√°rio</div>
          <div class="desc">Produto vendido por unidade</div>
        </div>
        <div class="tipo-option caixa" onclick="selecionarTipo('caixa')">
          <div class="icon">üì¶</div>
          <div class="label">Caixa Fechada</div>
          <div class="desc">Produto vendido em caixa</div>
        </div>
      </div>
      
      <div class="modal-grid">
        <div class="form-group full">
          <label>Nome do produto *</label>
          <input type="text" id="m-nome" placeholder="Ex: Detergente Neutro 500ml" />
        </div>
        <div class="form-group" id="grupo-qtd-caixa" style="display:none">
          <label>üì¶ Qtd por Caixa *</label>
          <input type="number" id="m-qtdPorCaixa" min="1" value="12" placeholder="Ex: 12" />
        </div>
        <div class="form-group">
          <label>SKU (c√≥digo)</label>
          <input type="text" id="m-sku" placeholder="Auto-gerado" readonly />
        </div>
        <div class="form-group">
          <label>üì¶ C√≥digo de Barras</label>
          <input type="text" id="m-codigoBarras" placeholder="Escaneie ou digite" />
        </div>
        <div class="form-group">
          <label>üíµ Pre√ßo de Custo (R$) *</label>
          <input type="number" id="m-precoCusto" step="0.01" min="0" placeholder="0.00" oninput="calcularMargem()" />
        </div>
        <div class="form-group">
          <label>üí∞ Pre√ßo de Venda (R$) *</label>
          <input type="number" id="m-preco" step="0.01" min="0" placeholder="0.00" oninput="calcularMargem()" />
        </div>
        <div class="form-group">
          <label>üìä Margem de Lucro</label>
          <input type="text" id="m-margem" readonly style="background:#e6f9ee;font-weight:bold;color:#0aa04e" placeholder="0%" />
        </div>
        <div class="form-group">
          <label id="label-quantidade">Quantidade em Estoque *</label>
          <input type="number" id="m-quantidade" min="0" placeholder="0" />
        </div>
        <div class="form-group">
          <label>Unidade</label>
          <select id="m-unidade">
            <option value="UN">UN - Unidade</option>
            <option value="L">L - Litro</option>
            <option value="KG">KG - Quilograma</option>
            <option value="CX">CX - Caixa</option>
            <option value="PCT">PCT - Pacote</option>
          </select>
        </div>
        <div class="form-group">
          <label>Estoque m√≠nimo</label>
          <input type="number" id="m-minimo" min="0" placeholder="0" />
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="fecharModal('modal-produto')">Cancelar</button>
        <button class="btn btn-primary" id="btn-salvar" onclick="salvarProduto()">üíæ Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal Ajuste de Estoque -->
  <div id="modal-ajuste" class="modal-backdrop">
    <div class="modal">
      <h3>üìä Ajustar Estoque</h3>
      <p id="ajuste-produto" style="color:var(--muted);margin:-10px 0 20px">Produto selecionado</p>
      
      <div class="modal-grid">
        <div class="form-group">
          <label>Tipo de movimenta√ß√£o</label>
          <select id="aj-tipo">
            <option value="entrada">‚ûï Entrada</option>
            <option value="saida">‚ûñ Sa√≠da</option>
          </select>
        </div>
        <div class="form-group">
          <label>Quantidade</label>
          <input type="number" id="aj-quantidade" min="1" value="1" />
        </div>
        <div class="form-group full">
          <label>Motivo (opcional)</label>
          <input type="text" id="aj-motivo" placeholder="Ex: Compra de fornecedor, Ajuste de invent√°rio..." />
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="fecharModal('modal-ajuste')">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmarAjuste()">‚úì Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Modal Confirmar Exclus√£o -->
  <div id="modal-delete" class="modal-backdrop">
    <div class="modal">
      <h3>‚ö†Ô∏è Confirmar Exclus√£o</h3>
      <p>Tem certeza que deseja excluir este produto? Esta a√ß√£o n√£o pode ser desfeita.</p>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="fecharModal('modal-delete')">Cancelar</button>
        <button class="btn btn-danger" onclick="confirmarExclusao()">üóëÔ∏è Excluir</button>
      </div>
    </div>
  </div>

  <!-- Modal Relat√≥rio de Lucros -->
  <div id="modal-relatorio" class="modal-backdrop">
    <div class="modal" style="max-width:800px">
      <h3>üìä Relat√≥rio de Lucros</h3>
      <div id="relatorio-content"></div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="fecharModal('modal-relatorio')">Fechar</button>
        <button class="btn btn-primary" onclick="imprimirRelatorioLucros()">üñ®Ô∏è Imprimir</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

<script>
// ============================================
// VARI√ÅVEIS GLOBAIS
// ============================================
let produtos = [];
let editandoId = null;
let ajustandoId = null;
let deletandoId = null;
let tipoAtual = 'unitario';
let tipoSelecionado = 'unitario';

// ============================================
// FUN√á√ïES UTILIT√ÅRIAS
// ============================================
function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, c => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[c]));
}

function formatMoney(valor) {
  return 'R$ ' + Number(valor || 0).toFixed(2).replace('.', ',');
}

function showToast(msg, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast show ' + type;
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// Calcular margem de lucro automaticamente
function calcularMargem() {
  const custo = parseFloat(document.getElementById('m-precoCusto').value) || 0;
  const venda = parseFloat(document.getElementById('m-preco').value) || 0;
  const margemInput = document.getElementById('m-margem');
  
  if (custo > 0 && venda > 0) {
    const lucro = venda - custo;
    const margemPct = ((lucro / custo) * 100).toFixed(1);
    const margemBruta = lucro.toFixed(2);
    
    margemInput.value = `${margemPct}% (R$ ${margemBruta.replace('.', ',')} de lucro)`;
    margemInput.style.color = lucro >= 0 ? '#0aa04e' : '#dc2626';
    margemInput.style.background = lucro >= 0 ? '#e6f9ee' : '#fef2f2';
  } else {
    margemInput.value = '‚Äî';
    margemInput.style.color = '#6b7280';
    margemInput.style.background = '#f4f7fb';
  }
}

function gerarSku(tipo) {
  const prefix = tipo === 'caixa' ? 'CX' : 'UN';
  let max = 0;
  produtos.filter(p => p.tipo === tipo).forEach(p => {
    const m = String(p.sku || '').match(/(\d+)/);
    if (m) {
      const num = parseInt(m[1], 10);
      if (num > max) max = num;
    }
  });
  return prefix + String(max + 1).padStart(4, '0');
}

function getStockStatus(produto) {
  if (produto.quantidade <= 0) return { text: 'Sem estoque', class: 'red' };
  if (produto.quantidade <= (produto.minimo || 0)) return { text: 'Baixo', class: 'yellow' };
  return { text: 'OK', class: 'green' };
}

// ============================================
// ABAS
// ============================================
function mudarAba(tipo) {
  tipoAtual = tipo;
  
  // Atualizar bot√µes das abas
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.tipo === tipo) {
      btn.classList.add('active');
    }
  });
  
  // Atualizar t√≠tulo e coluna
  const titulo = document.getElementById('titulo-lista');
  const colQtdCaixa = document.getElementById('col-qtd-caixa');
  
  if (tipo === 'caixa') {
    titulo.innerHTML = 'üì¶ Caixas Fechadas';
    colQtdCaixa.style.display = '';
  } else {
    titulo.innerHTML = 'üìÑ Produtos Unit√°rios';
    colQtdCaixa.style.display = 'none';
  }
  
  renderizarTabela();
}

// ============================================
// TIPO SELETOR NO MODAL
// ============================================
function selecionarTipo(tipo) {
  tipoSelecionado = tipo;
  
  document.querySelectorAll('.tipo-option').forEach(opt => {
    opt.classList.remove('active');
  });
  document.querySelector(`.tipo-option.${tipo}`).classList.add('active');
  
  // Atualizar UI
  const grupoQtdCaixa = document.getElementById('grupo-qtd-caixa');
  const labelQuantidade = document.getElementById('label-quantidade');
  const btnSalvar = document.getElementById('btn-salvar');
  const unidadeSelect = document.getElementById('m-unidade');
  
  if (tipo === 'caixa') {
    grupoQtdCaixa.style.display = '';
    labelQuantidade.textContent = 'Quantidade de Caixas *';
    btnSalvar.className = 'btn btn-purple';
    unidadeSelect.value = 'CX';
  } else {
    grupoQtdCaixa.style.display = 'none';
    labelQuantidade.textContent = 'Quantidade em Estoque *';
    btnSalvar.className = 'btn btn-primary';
    unidadeSelect.value = 'UN';
  }
  
  // Atualizar SKU
  document.getElementById('m-sku').value = gerarSku(tipo);
}

// ============================================
// MODAIS
// ============================================
function abrirModal(id) {
  document.getElementById(id).classList.add('show');
}

function fecharModal(id) {
  document.getElementById(id).classList.remove('show');
}

function abrirModalNovo(tipo = 'unitario') {
  editandoId = null;
  tipoSelecionado = tipo;
  
  document.getElementById('modal-title').innerHTML = tipo === 'caixa' ? 'üì¶ Nova Caixa Fechada' : 'üìÑ Novo Produto Unit√°rio';
  document.getElementById('tipo-selector').style.display = 'grid';
  document.getElementById('m-nome').value = '';
  document.getElementById('m-sku').value = gerarSku(tipo);
  document.getElementById('m-codigoBarras').value = '';
  document.getElementById('m-precoCusto').value = '';
  document.getElementById('m-preco').value = '';
  document.getElementById('m-margem').value = '‚Äî';
  document.getElementById('m-quantidade').value = '';
  document.getElementById('m-qtdPorCaixa').value = '12';
  document.getElementById('m-minimo').value = '5';
  
  selecionarTipo(tipo);
  abrirModal('modal-produto');
}

function abrirModalEditar(id) {
  const produto = produtos.find(p => (p._id || p.id) === id);
  if (!produto) return;

  editandoId = produto._id || produto.id;
  tipoSelecionado = produto.tipo || 'unitario';
  
  document.getElementById('modal-title').innerHTML = '‚úèÔ∏è Editar Produto';
  document.getElementById('tipo-selector').style.display = 'none'; // N√£o pode mudar tipo ao editar
  document.getElementById('m-nome').value = produto.nome || '';
  document.getElementById('m-sku').value = produto.sku || '';
  document.getElementById('m-codigoBarras').value = produto.codigoBarras || '';
  document.getElementById('m-precoCusto').value = produto.precoCusto || 0;
  document.getElementById('m-preco').value = produto.preco || 0;
  document.getElementById('m-quantidade').value = produto.quantidade || 0;
  document.getElementById('m-unidade').value = produto.unidade || 'UN';
  document.getElementById('m-minimo').value = produto.minimo || 0;
  document.getElementById('m-qtdPorCaixa').value = produto.qtdPorCaixa || 12;
  
  selecionarTipo(tipoSelecionado);
  calcularMargem();
  abrirModal('modal-produto');
}

function abrirModalAjuste(id) {
  const produto = produtos.find(p => (p._id || p.id) === id);
  if (!produto) return;

  ajustandoId = produto._id || produto.id;
  document.getElementById('ajuste-produto').textContent = produto.nome;
  document.getElementById('aj-tipo').value = 'entrada';
  document.getElementById('aj-quantidade').value = 1;
  document.getElementById('aj-motivo').value = '';
  abrirModal('modal-ajuste');
}

function abrirModalDelete(id) {
  deletandoId = id;
  abrirModal('modal-delete');
}

// ============================================
// CARREGAR DADOS
// ============================================
async function carregarProdutos() {
  try {
    const res = await fetch('/api/produtos');
    if (!res.ok) throw new Error('Erro ao carregar');
    produtos = await res.json();
    
    atualizarEstatisticas();
    renderizarTabela();
  } catch (e) {
    console.error(e);
    document.getElementById('table-body').innerHTML = `
      <tr>
        <td colspan="10" class="empty-state">
          <div class="icon">‚ùå</div>
          <h4>Erro ao carregar produtos</h4>
        </td>
      </tr>
    `;
  }
}

// ============================================
// ATUALIZAR ESTAT√çSTICAS
// ============================================
function atualizarEstatisticas() {
  let valorTotal = 0;
  let baixo = 0;
  let lucroEstimado = 0;
  let unitarios = 0;
  let caixas = 0;

  produtos.forEach(p => {
    const qtd = p.quantidade || 0;
    const venda = p.preco || 0;
    const custo = p.precoCusto || 0;
    
    valorTotal += qtd * venda;
    lucroEstimado += qtd * (venda - custo);
    
    if (qtd > 0 && qtd <= (p.minimo || 0)) baixo++;
    
    if (p.tipo === 'caixa') caixas++;
    else unitarios++;
  });

  document.getElementById('stat-unitarios').textContent = unitarios;
  document.getElementById('stat-caixas').textContent = caixas;
  document.getElementById('stat-valor').textContent = formatMoney(valorTotal);
  document.getElementById('stat-baixo').textContent = baixo;
  document.getElementById('stat-lucro').textContent = formatMoney(lucroEstimado);
  
  document.getElementById('count-unitarios').textContent = unitarios;
  document.getElementById('count-caixas').textContent = caixas;
}

// ============================================
// RENDERIZAR TABELA
// ============================================
function renderizarTabela() {
  const tbody = document.getElementById('table-body');
  const searchTerm = document.getElementById('search').value.toLowerCase();
  const colQtdCaixa = document.getElementById('col-qtd-caixa');
  
  let lista = produtos.filter(p => {
    const matchTipo = (p.tipo || 'unitario') === tipoAtual;
    const matchSearch = !searchTerm || 
      (p.nome || '').toLowerCase().includes(searchTerm) ||
      (p.sku || '').toLowerCase().includes(searchTerm);
    return matchTipo && matchSearch;
  });

  if (lista.length === 0) {
    const tipoLabel = tipoAtual === 'caixa' ? 'caixas' : 'produtos unit√°rios';
    tbody.innerHTML = `
      <tr>
        <td colspan="10" class="empty-state">
          <div class="icon">${tipoAtual === 'caixa' ? 'üì¶' : 'üìÑ'}</div>
          <h4>Nenhum(a) ${tipoLabel} encontrado(a)</h4>
          <p>Clique em "Nov${tipoAtual === 'caixa' ? 'a Caixa' : 'o Unit√°rio'}" para cadastrar</p>
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = lista.map(p => {
    const status = getStockStatus(p);
    const isLow = p.quantidade <= (p.minimo || 0);
    const custo = p.precoCusto || 0;
    const venda = p.preco || 0;
    const lucro = venda - custo;
    const margemPct = custo > 0 ? ((lucro / custo) * 100).toFixed(0) : 0;
    const margemClass = lucro > 0 ? 'margem-positiva' : (lucro < 0 ? 'margem-negativa' : '');
    const qtdPorCaixaCol = tipoAtual === 'caixa' ? `<td><strong>${p.qtdPorCaixa || 1}</strong> un</td>` : '';

    return `
      <tr class="${isLow ? 'lowstock' : ''}">
        <td>
          <div class="produto-info">
            <span class="produto-nome">${escapeHtml(p.nome)}</span>
          </div>
        </td>
        <td><span class="produto-sku">${escapeHtml(p.sku || '‚Äî')}</span></td>
        ${qtdPorCaixaCol}
        <td style="color:var(--muted)">${formatMoney(custo)}</td>
        <td><strong>${formatMoney(venda)}</strong></td>
        <td class="${margemClass}"><strong>${formatMoney(lucro)}</strong></td>
        <td class="${margemClass}">${margemPct}%</td>
        <td><strong>${p.quantidade}</strong> ${escapeHtml(p.unidade || 'UN')}</td>
        <td><span class="badge ${status.class}">${status.text}</span></td>
        <td>
          <div class="table-actions">
            <button class="btn btn-ghost btn-sm" onclick="abrirModalEditar('${p._id || p.id}')" title="Editar">‚úèÔ∏è</button>
            <button class="btn btn-info btn-sm" onclick="abrirModalAjuste('${p._id || p.id}')" title="Ajustar estoque">üìä</button>
            <button class="btn btn-danger btn-sm" onclick="abrirModalDelete('${p._id || p.id}')" title="Excluir">üóëÔ∏è</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

// ============================================
// SALVAR PRODUTO
// ============================================
async function salvarProduto() {
  const nome = document.getElementById('m-nome').value.trim();
  const sku = document.getElementById('m-sku').value.trim();
  const codigoBarras = document.getElementById('m-codigoBarras').value.trim();
  const precoCusto = parseFloat(document.getElementById('m-precoCusto').value) || 0;
  const preco = parseFloat(document.getElementById('m-preco').value) || 0;
  const quantidade = parseInt(document.getElementById('m-quantidade').value) || 0;
  const unidade = document.getElementById('m-unidade').value;
  const minimo = parseInt(document.getElementById('m-minimo').value) || 0;
  const qtdPorCaixa = parseInt(document.getElementById('m-qtdPorCaixa').value) || 1;

  if (!nome) {
    showToast('Nome √© obrigat√≥rio', 'error');
    return;
  }

  const payload = { 
    nome, sku, codigoBarras, precoCusto, preco, quantidade, unidade, minimo,
    tipo: tipoSelecionado,
    qtdPorCaixa: tipoSelecionado === 'caixa' ? qtdPorCaixa : 1
  };

  try {
    const url = editandoId ? `/api/produtos/${editandoId}` : '/api/produtos';
    const method = editandoId ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) throw new Error('Erro ao salvar');

    const tipoLabel = tipoSelecionado === 'caixa' ? 'Caixa' : 'Produto';
    showToast(editandoId ? `‚úÖ ${tipoLabel} atualizado!` : `‚úÖ ${tipoLabel} cadastrado!`);
    fecharModal('modal-produto');
    await carregarProdutos();
    
    // Mudar para a aba do tipo cadastrado
    mudarAba(tipoSelecionado);
  } catch (e) {
    showToast(e.message, 'error');
  }
}

// ============================================
// AJUSTAR ESTOQUE
// ============================================
async function confirmarAjuste() {
  if (!ajustandoId) return;

  const tipo = document.getElementById('aj-tipo').value;
  const quantidade = parseInt(document.getElementById('aj-quantidade').value) || 0;

  if (quantidade <= 0) {
    showToast('Quantidade inv√°lida', 'error');
    return;
  }

  try {
    const res = await fetch(`/api/produtos/${ajustandoId}/ajustar`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tipo, quantidade })
    });

    if (!res.ok) throw new Error('Erro ao ajustar');

    const msg = tipo === 'entrada' ? `‚úÖ +${quantidade} adicionado!` : `‚úÖ -${quantidade} removido!`;
    showToast(msg);
    fecharModal('modal-ajuste');
    await carregarProdutos();
  } catch (e) {
    showToast(e.message, 'error');
  }
}

// ============================================
// EXCLUIR PRODUTO
// ============================================
async function confirmarExclusao() {
  if (!deletandoId) return;

  try {
    const res = await fetch(`/api/produtos/${deletandoId}`, { method: 'DELETE' });
    if (!res.ok) throw new Error('Erro ao excluir');

    showToast('üóëÔ∏è Produto exclu√≠do!');
    fecharModal('modal-delete');
    await carregarProdutos();
  } catch (e) {
    showToast(e.message, 'error');
  }
}

// ============================================
// RELAT√ìRIO DE LUCROS
// ============================================
function abrirRelatorio() {
  let totalCusto = 0;
  let totalVenda = 0;
  let totalLucro = 0;
  
  const linhas = produtos.map(p => {
    const qtd = p.quantidade || 0;
    const custo = p.precoCusto || 0;
    const venda = p.preco || 0;
    const custoTotal = qtd * custo;
    const vendaTotal = qtd * venda;
    const lucro = vendaTotal - custoTotal;
    const margemPct = custo > 0 ? ((venda - custo) / custo * 100).toFixed(1) : 0;
    const tipoIcon = p.tipo === 'caixa' ? 'üì¶' : 'üìÑ';
    
    totalCusto += custoTotal;
    totalVenda += vendaTotal;
    totalLucro += lucro;
    
    return `
      <tr>
        <td>${tipoIcon} ${escapeHtml(p.nome)}</td>
        <td style="text-align:center">${qtd}</td>
        <td style="text-align:right">${formatMoney(custo)}</td>
        <td style="text-align:right">${formatMoney(venda)}</td>
        <td style="text-align:right">${formatMoney(custoTotal)}</td>
        <td style="text-align:right">${formatMoney(vendaTotal)}</td>
        <td style="text-align:right;color:${lucro >= 0 ? '#0aa04e' : '#dc2626'};font-weight:bold">${formatMoney(lucro)}</td>
        <td style="text-align:center">${margemPct}%</td>
      </tr>
    `;
  }).join('');
  
  const margemMedia = totalCusto > 0 ? ((totalLucro / totalCusto) * 100).toFixed(1) : 0;
  
  const unitarios = produtos.filter(p => p.tipo !== 'caixa').length;
  const caixas = produtos.filter(p => p.tipo === 'caixa').length;
  
  document.getElementById('relatorio-content').innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px">
      <div style="background:#f0f3f7;padding:14px;border-radius:10px;text-align:center">
        <p style="margin:0;font-size:12px;color:#6b7280">Custo Total</p>
        <h3 style="margin:4px 0 0;font-size:16px">${formatMoney(totalCusto)}</h3>
      </div>
      <div style="background:#f0f3f7;padding:14px;border-radius:10px;text-align:center">
        <p style="margin:0;font-size:12px;color:#6b7280">Venda Total</p>
        <h3 style="margin:4px 0 0;font-size:16px">${formatMoney(totalVenda)}</h3>
      </div>
      <div style="background:#e6f9ee;padding:14px;border-radius:10px;text-align:center">
        <p style="margin:0;font-size:12px;color:#0aa04e">Lucro Estimado</p>
        <h3 style="margin:4px 0 0;font-size:16px;color:#0aa04e">${formatMoney(totalLucro)}</h3>
      </div>
      <div style="background:#e6f9ee;padding:14px;border-radius:10px;text-align:center">
        <p style="margin:0;font-size:12px;color:#0aa04e">Margem M√©dia</p>
        <h3 style="margin:4px 0 0;font-size:16px;color:#0aa04e">${margemMedia}%</h3>
      </div>
    </div>
    <div style="display:flex;gap:20px;margin-bottom:16px">
      <span style="font-size:14px">üìÑ <strong>${unitarios}</strong> unit√°rios</span>
      <span style="font-size:14px">üì¶ <strong>${caixas}</strong> caixas</span>
    </div>
    <div style="max-height:300px;overflow-y:auto">
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead>
          <tr style="background:#f0f3f7">
            <th style="padding:8px;text-align:left">Produto</th>
            <th style="padding:8px;text-align:center">Qtd</th>
            <th style="padding:8px;text-align:right">Custo</th>
            <th style="padding:8px;text-align:right">Venda</th>
            <th style="padding:8px;text-align:right">Custo Total</th>
            <th style="padding:8px;text-align:right">Venda Total</th>
            <th style="padding:8px;text-align:right">Lucro</th>
            <th style="padding:8px;text-align:center">Margem</th>
          </tr>
        </thead>
        <tbody>${linhas}</tbody>
      </table>
    </div>
  `;
  
  abrirModal('modal-relatorio');
}

function imprimirRelatorioLucros() {
  const content = document.getElementById('relatorio-content').innerHTML;
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Relat√≥rio de Lucros - MegaClean</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h1 { color: #0aa04e; font-size: 24px; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 8px; border: 1px solid #ddd; }
        th { background: #f0f3f7; }
      </style>
    </head>
    <body>
      <h1>üßπ MegaClean - Relat√≥rio de Lucros</h1>
      <p>Data: ${new Date().toLocaleDateString('pt-BR')}</p>
      ${content}
    </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
}

// ============================================
// EVENTOS
// ============================================
document.getElementById('search').addEventListener('input', renderizarTabela);

// Fechar modais clicando fora
document.querySelectorAll('.modal-backdrop').forEach(modal => {
  modal.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-backdrop')) {
      modal.classList.remove('show');
    }
  });
});

// ============================================
// INICIALIZA√á√ÉO
// ============================================
carregarProdutos();
</script>
</body>
</html>
