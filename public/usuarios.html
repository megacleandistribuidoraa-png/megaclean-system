<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gerenciar Usu√°rios - MegaClean</title>
<style>
:root{
  --bg:#f4f7fb;
  --card:#fff;
  --primary:#0aa04e;
  --primary-light:#e6f9ee;
  --primary-600:#0a8a44;
  --muted:#6b7280;
  --danger:#dc2626;
  --danger-light:#fef2f2;
  --warning:#f59e0b;
  --warning-light:#fffbeb;
  --info:#3b82f6;
  --info-light:#eff6ff;
  --purple:#8b5cf6;
  --purple-light:#f5f3ff;
  --radius:12px;
  --shadow: 0 8px 24px rgba(12,20,30,0.06);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: 'Segoe UI', Roboto, Arial, sans-serif;
  background:linear-gradient(180deg,#f7fafc 0%, var(--bg) 100%);
  color:#0f172a;
  padding:22px;
  min-height:100vh;
}
.container{max-width:1200px;margin:0 auto}

/* Header */
header{display:flex;align-items:center;justify-content:space-between;gap:18px;margin-bottom:22px;flex-wrap:wrap}
header h1{margin:0;color:var(--primary);font-size:28px;display:flex;align-items:center;gap:10px}
header h1 span{font-size:32px}
header p{margin:4px 0 0;color:var(--muted);font-size:14px}
.back-link{color:var(--primary);text-decoration:none;font-weight:600;display:inline-flex;align-items:center;gap:6px}
.back-link:hover{text-decoration:underline}

/* Cards de estat√≠sticas */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:22px}
.stat-card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);display:flex;align-items:center;gap:14px}
.stat-card .icon{width:50px;height:50px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px}
.stat-card .icon.green{background:var(--primary-light);color:var(--primary)}
.stat-card .icon.blue{background:var(--info-light);color:var(--info)}
.stat-card .icon.purple{background:var(--purple-light);color:var(--purple)}
.stat-card .info h3{margin:0;font-size:24px;font-weight:800}
.stat-card .info p{margin:4px 0 0;color:var(--muted);font-size:13px}

/* Card principal */
.card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);margin-bottom:18px}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:12px}
.card-title{font-size:18px;font-weight:700;margin:0;display:flex;align-items:center;gap:8px}

/* Grid layout */
.grid{display:grid;grid-template-columns:420px 1fr;gap:20px;align-items:start}

/* Formul√°rio */
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:8px}
.form-group input,.form-group select{width:100%;padding:12px 14px;border:2px solid #e6e9ef;border-radius:10px;font-size:14px;transition:all .2s;background:#f8fafc}
.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary);background:#fff}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-actions{display:flex;gap:10px;margin-top:20px}

/* Bot√µes */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-radius:10px;border:none;cursor:pointer;font-weight:600;font-size:14px;transition:all .2s}
.btn-primary{background:linear-gradient(135deg, #0aa04e 0%, #059669 100%);color:#fff;box-shadow:0 4px 14px rgba(10,160,78,0.2)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(10,160,78,0.3)}
.btn-ghost{background:#f8fafc;color:var(--muted);border:2px solid #e6e9ef}
.btn-ghost:hover{border-color:var(--primary);color:var(--primary)}
.btn-danger{background:var(--danger-light);color:var(--danger)}
.btn-danger:hover{background:var(--danger);color:#fff}
.btn-warning{background:var(--warning-light);color:#b45309}
.btn-warning:hover{background:var(--warning);color:#fff}
.btn-sm{padding:6px 10px;font-size:12px}

/* Tabela */
.table-container{overflow-x:auto}
table{width:100%;border-collapse:collapse;font-size:14px}
thead th{background:#f8fafc;padding:14px 12px;text-align:left;font-weight:600;color:var(--muted);border-bottom:2px solid #e6e9ef;white-space:nowrap}
tbody tr{transition:background .15s}
tbody tr:hover{background:#f8fafc}
tbody tr.inativo{opacity:0.6}
tbody td{padding:14px 12px;border-bottom:1px solid #f0f3f7;vertical-align:middle}

/* Badge */
.badge{display:inline-flex;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600}
.badge.admin{background:var(--purple-light);color:var(--purple)}
.badge.operador{background:var(--info-light);color:var(--info)}
.badge.ativo{background:var(--primary-light);color:var(--primary)}
.badge.inativo{background:var(--danger-light);color:var(--danger)}

/* Info box */
.info-box{padding:14px 16px;background:var(--info-light);border:2px solid #bfdbfe;border-radius:10px;margin-bottom:16px}
.info-box h5{margin:0 0 8px;font-size:14px;color:var(--info)}
.info-box p{margin:0;font-size:13px;color:#1e40af}
.info-box ul{margin:8px 0 0;padding-left:20px;font-size:13px;color:#1e40af}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;background:#0f172a;color:#fff;padding:14px 20px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);transform:translateY(100px);opacity:0;transition:all .3s ease;z-index:200;font-weight:500}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{background:var(--primary)}
.toast.error{background:var(--danger)}

/* Feedback */
.feedback{min-height:20px;margin-top:8px;font-size:13px;font-weight:500}
.feedback.error{color:var(--danger)}
.feedback.success{color:var(--primary)}

/* Modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:none;align-items:center;justify-content:center;z-index:100;padding:20px}
.modal-backdrop.show{display:flex}
.modal{background:#fff;padding:24px;border-radius:16px;max-width:500px;width:100%;box-shadow:0 20px 60px rgba(2,6,23,0.3);animation:modalIn .25s ease}
@keyframes modalIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
.modal h3{margin:0 0 12px;font-size:20px;display:flex;align-items:center;gap:10px}
.modal p{margin:0 0 20px;color:var(--muted);font-size:14px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end}

/* Empty state */
.empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
.empty-state .icon{font-size:40px;margin-bottom:10px}

/* Responsivo */
@media (max-width:900px){
  .grid{grid-template-columns:1fr}
  header{flex-direction:column;align-items:flex-start}
  .form-row{grid-template-columns:1fr}
}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <a href="/admin.html" class="back-link">‚Üê Voltar ao painel</a>
        <h1><span>üë§</span> Gerenciar Usu√°rios</h1>
        <p>Crie e gerencie os usu√°rios do sistema</p>
      </div>
    </header>

    <!-- Cards de estat√≠sticas -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="icon green">üë•</div>
        <div class="info">
          <h3 id="stat-total">0</h3>
          <p>Total de usu√°rios</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="icon purple">üëë</div>
        <div class="info">
          <h3 id="stat-admins">0</h3>
          <p>Administradores</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="icon blue">üë§</div>
        <div class="info">
          <h3 id="stat-operadores">0</h3>
          <p>Operadores</p>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- Formul√°rio -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title" id="form-title">‚ûï Novo Usu√°rio</h2>
        </div>

        <div class="info-box">
          <h5>‚ÑπÔ∏è Tipos de Usu√°rio</h5>
          <p><strong>Administrador:</strong> Acesso total ao sistema</p>
          <p><strong>Operador:</strong> Acesso apenas a:</p>
          <ul>
            <li>Clientes (cadastrar/editar)</li>
            <li>Pedidos (criar/visualizar)</li>
          </ul>
        </div>
        
        <form id="form-usuario" autocomplete="off">
          <input type="hidden" id="usuario-id" />
          
          <div class="form-group">
            <label for="nome">Nome completo *</label>
            <input type="text" id="nome" placeholder="Nome do usu√°rio" required />
          </div>

          <div class="form-group">
            <label for="username">Nome de usu√°rio (login) *</label>
            <input type="text" id="username" placeholder="Ex: joao.silva" required />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="password">Senha *</label>
              <input type="password" id="password" placeholder="M√≠nimo 6 caracteres" />
            </div>
            <div class="form-group">
              <label for="role">Tipo de usu√°rio *</label>
              <select id="role">
                <option value="operador">Operador</option>
                <option value="admin">Administrador</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="status">Status</label>
            <select id="status">
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
            </select>
          </div>

          <div id="feedback" class="feedback"></div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="btn-salvar">
              üíæ Salvar Usu√°rio
            </button>
            <button type="button" class="btn btn-ghost" id="btn-limpar">
              Limpar
            </button>
          </div>
        </form>
      </div>

      <!-- Lista de usu√°rios -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">üìã Usu√°rios Cadastrados</h2>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Nome</th>
                <th>Usu√°rio</th>
                <th>Tipo</th>
                <th>Status</th>
                <th style="width:120px">A√ß√µes</th>
              </tr>
            </thead>
            <tbody id="table-body">
              <tr>
                <td colspan="5" class="empty-state">
                  <div class="icon">üë•</div>
                  <p>Carregando...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirma√ß√£o de exclus√£o -->
  <div id="modal-delete" class="modal-backdrop">
    <div class="modal">
      <h3>‚ö†Ô∏è Excluir Usu√°rio</h3>
      <p>Tem certeza que deseja excluir este usu√°rio? Esta a√ß√£o n√£o pode ser desfeita.</p>
      <div style="background:#fef2f2;padding:12px;border-radius:8px;margin-bottom:20px">
        <strong style="color:var(--danger)" id="delete-nome">Nome do usu√°rio</strong>
      </div>
      <div class="modal-actions">
        <button class="btn btn-ghost" onclick="fecharModal()">Cancelar</button>
        <button class="btn btn-danger" onclick="confirmarExclusao()">üóëÔ∏è Excluir</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

<script>
// ============================================
// VARI√ÅVEIS GLOBAIS
// ============================================
let usuarios = [];
let editandoId = null;
let deletandoId = null;

// ============================================
// FUN√á√ïES UTILIT√ÅRIAS
// ============================================
function getToken() {
  return localStorage.getItem('admin_token') || '';
}

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, c => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
  }[c]));
}

function showToast(msg, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast show ' + type;
  setTimeout(() => toast.classList.remove('show'), 3000);
}

function setFeedback(msg, isError = false) {
  const feedback = document.getElementById('feedback');
  feedback.textContent = msg;
  feedback.className = 'feedback ' + (isError ? 'error' : 'success');
  if (!isError) setTimeout(() => feedback.textContent = '', 3000);
}

// ============================================
// CARREGAR DADOS
// ============================================
async function carregarUsuarios() {
  try {
    const res = await fetch('/api/usuarios', {
      headers: { 'x-auth-token': getToken() }
    });
    
    if (!res.ok) {
      if (res.status === 403) {
        showToast('Acesso negado. Apenas administradores.', 'error');
        setTimeout(() => window.location.href = '/admin.html', 2000);
        return;
      }
      throw new Error('Erro ao carregar');
    }
    
    usuarios = await res.json();
    atualizarEstatisticas();
    renderizarTabela();
  } catch (e) {
    console.error(e);
    document.getElementById('table-body').innerHTML = `
      <tr>
        <td colspan="5" class="empty-state">
          <div class="icon">‚ùå</div>
          <p>Erro ao carregar usu√°rios</p>
        </td>
      </tr>
    `;
  }
}

// ============================================
// ATUALIZAR ESTAT√çSTICAS
// ============================================
function atualizarEstatisticas() {
  const admins = usuarios.filter(u => u.role === 'admin').length;
  const operadores = usuarios.filter(u => u.role === 'operador').length;
  
  document.getElementById('stat-total').textContent = usuarios.length;
  document.getElementById('stat-admins').textContent = admins;
  document.getElementById('stat-operadores').textContent = operadores;
}

// ============================================
// RENDERIZAR TABELA
// ============================================
function renderizarTabela() {
  const tbody = document.getElementById('table-body');

  if (usuarios.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="empty-state">
          <div class="icon">üë•</div>
          <p>Nenhum usu√°rio cadastrado</p>
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = usuarios.map(u => {
    const roleLabel = u.role === 'admin' ? 'üëë Admin' : 'üë§ Operador';
    const roleClass = u.role === 'admin' ? 'admin' : 'operador';
    const statusLabel = u.status === 'ativo' ? '‚úì Ativo' : '‚úï Inativo';
    const statusClass = u.status === 'ativo' ? 'ativo' : 'inativo';
    const isMainAdmin = u.id === 1;

    return `
      <tr class="${u.status}">
        <td><strong>${escapeHtml(u.nome)}</strong></td>
        <td>${escapeHtml(u.username)}</td>
        <td><span class="badge ${roleClass}">${roleLabel}</span></td>
        <td><span class="badge ${statusClass}">${statusLabel}</span></td>
        <td>
          <button class="btn btn-warning btn-sm" onclick="editarUsuario(${u.id})" title="Editar">‚úèÔ∏è</button>
          ${!isMainAdmin ? `<button class="btn btn-danger btn-sm" onclick="abrirModalExclusao(${u.id})" title="Excluir">üóëÔ∏è</button>` : ''}
        </td>
      </tr>
    `;
  }).join('');
}

// ============================================
// FORMUL√ÅRIO
// ============================================
document.getElementById('form-usuario').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const id = document.getElementById('usuario-id').value;
  const nome = document.getElementById('nome').value.trim();
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  const role = document.getElementById('role').value;
  const status = document.getElementById('status').value;

  if (!nome || !username) {
    setFeedback('Preencha nome e usu√°rio', true);
    return;
  }

  if (!editandoId && (!password || password.length < 6)) {
    setFeedback('Senha deve ter pelo menos 6 caracteres', true);
    return;
  }

  const payload = { nome, username, role, status };
  if (password) payload.password = password;

  try {
    const url = editandoId ? `/api/usuarios/${editandoId}` : '/api/usuarios';
    const method = editandoId ? 'PUT' : 'POST';

    const res = await fetch(url, {
      method,
      headers: { 
        'Content-Type': 'application/json',
        'x-auth-token': getToken()
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.error || 'Erro ao salvar');
    }

    showToast(editandoId ? '‚úÖ Usu√°rio atualizado!' : '‚úÖ Usu√°rio criado!');
    limparFormulario();
    await carregarUsuarios();
  } catch (e) {
    setFeedback(e.message, true);
  }
});

function limparFormulario() {
  document.getElementById('form-usuario').reset();
  document.getElementById('usuario-id').value = '';
  document.getElementById('form-title').innerHTML = '‚ûï Novo Usu√°rio';
  document.getElementById('btn-salvar').innerHTML = 'üíæ Salvar Usu√°rio';
  document.getElementById('password').placeholder = 'M√≠nimo 6 caracteres';
  document.getElementById('feedback').textContent = '';
  editandoId = null;
}

function editarUsuario(id) {
  const usuario = usuarios.find(u => u.id === id);
  if (!usuario) return;

  editandoId = id;
  document.getElementById('usuario-id').value = id;
  document.getElementById('nome').value = usuario.nome;
  document.getElementById('username').value = usuario.username;
  document.getElementById('password').value = '';
  document.getElementById('password').placeholder = 'Deixe em branco para manter';
  document.getElementById('role').value = usuario.role;
  document.getElementById('status').value = usuario.status;

  document.getElementById('form-title').innerHTML = '‚úèÔ∏è Editar Usu√°rio';
  document.getElementById('btn-salvar').innerHTML = 'üíæ Atualizar Usu√°rio';
  
  document.getElementById('nome').focus();
}

// ============================================
// EXCLUS√ÉO
// ============================================
function abrirModalExclusao(id) {
  const usuario = usuarios.find(u => u.id === id);
  if (!usuario) return;

  deletandoId = id;
  document.getElementById('delete-nome').textContent = usuario.nome;
  document.getElementById('modal-delete').classList.add('show');
}

function fecharModal() {
  document.getElementById('modal-delete').classList.remove('show');
  deletandoId = null;
}

async function confirmarExclusao() {
  if (!deletandoId) return;

  try {
    const res = await fetch(`/api/usuarios/${deletandoId}`, {
      method: 'DELETE',
      headers: { 'x-auth-token': getToken() }
    });

    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.error || 'Erro ao excluir');
    }

    showToast('üóëÔ∏è Usu√°rio exclu√≠do!');
    fecharModal();
    limparFormulario();
    await carregarUsuarios();
  } catch (e) {
    showToast(e.message, 'error');
  }
}

// ============================================
// EVENTOS
// ============================================
document.getElementById('btn-limpar').addEventListener('click', limparFormulario);

document.getElementById('modal-delete').addEventListener('click', (e) => {
  if (e.target.id === 'modal-delete') fecharModal();
});

// ============================================
// INICIALIZA√á√ÉO
// ============================================
// Verificar se est√° logado
if (!getToken()) {
  window.location.href = '/index.html';
} else {
  carregarUsuarios();
}
</script>
</body>
</html>











