<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Configura√ß√£o NF-e - MegaClean</title>
  <style>
:root {
  --primary: #0aa04e;
  --primary-dark: #088a42;
  --primary-light: #e8f5ed;
  --purple: #8b5cf6;
  --purple-light: #f3f0ff;
  --warning: #f59e0b;
  --warning-light: #fff7ed;
  --danger: #ef4444;
  --danger-light: #fef2f2;
  --success: #10b981;
  --success-light: #ecfdf5;
  --muted: #64748b;
  --border: #e2e8f0;
  --bg: #f1f5f9;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { 
  font-family: 'Segoe UI', system-ui, sans-serif; 
  background: var(--bg); 
  min-height: 100vh;
  padding: 20px;
}
.container { max-width: 900px; margin: 0 auto; }

header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 20px;
}
header h1 { font-size: 28px; color: #1e293b; display: flex; align-items: center; gap: 12px; }
header p { color: var(--muted); margin-top: 4px; }
.back-link { 
  color: var(--primary); 
  text-decoration: none; 
  font-size: 14px; 
  margin-bottom: 8px; 
  display: inline-block;
}
.back-link:hover { text-decoration: underline; }

/* Status Card */
.status-card {
  background: #fff;
  border-radius: 16px;
  padding: 20px 24px;
  margin-bottom: 24px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  display: flex;
  align-items: center;
  gap: 16px;
}
.status-card.success { border-left: 4px solid var(--success); }
.status-card.warning { border-left: 4px solid var(--warning); }
.status-card.error { border-left: 4px solid var(--danger); }
.status-icon { font-size: 32px; }
.status-info h3 { font-size: 16px; margin-bottom: 4px; }
.status-info p { font-size: 13px; color: var(--muted); }

/* Sections */
.section {
  background: #fff;
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.section-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
}
.section-header .icon { font-size: 24px; }
.section-header h2 { font-size: 18px; color: #1e293b; }
.section-header p { font-size: 13px; color: var(--muted); margin-top: 2px; }

/* Form */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 16px;
}
.form-group { margin-bottom: 16px; }
.form-group.full { grid-column: 1 / -1; }
.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 6px;
}
.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 12px 14px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 14px;
  transition: all .2s;
  background: #f8fafc;
}
.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--primary);
  background: #fff;
}
.form-group small {
  display: block;
  font-size: 12px;
  color: var(--muted);
  margin-top: 4px;
}
.form-group textarea { resize: vertical; min-height: 100px; }

/* Provider Selector */
.provider-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.provider-option {
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  cursor: pointer;
  transition: all .2s;
  text-align: center;
}
.provider-option:hover { border-color: #ccc; }
.provider-option.active {
  border-color: var(--primary);
  background: var(--primary-light);
}
.provider-option .name { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
.provider-option .price { font-size: 12px; color: var(--muted); }
.provider-option .icon { font-size: 28px; margin-bottom: 8px; }

/* Buttons */
.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 10px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all .2s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-dark); }
.btn-ghost { background: #f1f5f9; color: #475569; }
.btn-ghost:hover { background: #e2e8f0; }
.btn-warning { background: var(--warning); color: #fff; }
.btn-warning:hover { background: #d97706; }

.actions {
  display: flex;
  gap: 12px;
  margin-top: 24px;
  flex-wrap: wrap;
}

/* Tabs */
.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
  border-bottom: 2px solid var(--border);
  padding-bottom: 0;
}
.tab-btn {
  padding: 12px 20px;
  border: none;
  background: none;
  font-size: 14px;
  font-weight: 600;
  color: var(--muted);
  cursor: pointer;
  border-bottom: 3px solid transparent;
  margin-bottom: -2px;
  transition: all .2s;
}
.tab-btn:hover { color: #333; }
.tab-btn.active { 
  color: var(--primary); 
  border-bottom-color: var(--primary);
}
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Alert Box */
.alert {
  padding: 16px 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}
.alert.info { background: #eff6ff; border: 1px solid #bfdbfe; }
.alert.warning { background: var(--warning-light); border: 1px solid #fed7aa; }
.alert.success { background: var(--success-light); border: 1px solid #a7f3d0; }
.alert .icon { font-size: 20px; }
.alert .content { flex: 1; }
.alert .title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
.alert .text { font-size: 13px; color: #555; }

/* File Upload */
.file-upload {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 30px;
  text-align: center;
  cursor: pointer;
  transition: all .2s;
}
.file-upload:hover { border-color: var(--primary); background: var(--primary-light); }
.file-upload .icon { font-size: 40px; margin-bottom: 12px; }
.file-upload .text { font-size: 14px; color: var(--muted); }
.file-upload .filename { 
  font-weight: 600; 
  color: var(--primary); 
  margin-top: 8px;
  font-size: 13px;
}
.file-upload input[type="file"] { display: none; }

/* Toast */
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  background: #1e293b;
  color: #fff;
  padding: 16px 24px;
  border-radius: 12px;
  font-size: 14px;
  z-index: 9999;
  animation: slideIn .3s ease;
}
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
@keyframes slideIn { from { transform: translateY(100px); opacity: 0; } }

/* Responsive */
@media (max-width: 768px) {
  .form-grid { grid-template-columns: 1fr; }
  .provider-grid { grid-template-columns: 1fr 1fr; }
  .tabs { overflow-x: auto; }
}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <a href="/admin.html" class="back-link">‚Üê Voltar ao painel</a>
        <h1><span>üìÑ</span> Configura√ß√£o NF-e</h1>
        <p>Configure a emiss√£o de Notas Fiscais Eletr√¥nicas</p>
      </div>
    </header>

    <!-- Status -->
    <div id="status-card" class="status-card warning">
      <div class="status-icon">‚ö†Ô∏è</div>
      <div class="status-info">
        <h3>NF-e n√£o configurada</h3>
        <p>Preencha os dados abaixo para ativar a emiss√£o de notas fiscais</p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="mudarTab('provedor')">üîå Provedor</button>
      <button class="tab-btn" onclick="mudarTab('empresa')">üè¢ Dados da Empresa</button>
      <button class="tab-btn" onclick="mudarTab('certificado')">üîê Certificado Digital</button>
      <button class="tab-btn" onclick="mudarTab('fiscal')">üìã Config. Fiscal</button>
    </div>

    <!-- Tab: Provedor -->
    <div id="tab-provedor" class="tab-content active">
      <div class="section">
        <div class="section-header">
          <span class="icon">üîå</span>
          <div>
            <h2>Escolha o Provedor de NF-e</h2>
            <p>Selecione qual API ser√° usada para emitir as notas</p>
          </div>
        </div>

        <div class="provider-grid">
          <div class="provider-option active" data-provider="focus_nfe" onclick="selecionarProvedor('focus_nfe')">
            <div class="icon">üéØ</div>
            <div class="name">Focus NFe</div>
            <div class="price">~R$ 0,12/nota</div>
          </div>
          <div class="provider-option" data-provider="nfe_io" onclick="selecionarProvedor('nfe_io')">
            <div class="icon">üì°</div>
            <div class="name">NFe.io</div>
            <div class="price">~R$ 0,15/nota</div>
          </div>
          <div class="provider-option" data-provider="enotas" onclick="selecionarProvedor('enotas')">
            <div class="icon">üìù</div>
            <div class="name">eNotas</div>
            <div class="price">A partir R$ 49/m√™s</div>
          </div>
          <div class="provider-option" data-provider="manual" onclick="selecionarProvedor('manual')">
            <div class="icon">‚úã</div>
            <div class="name">Manual</div>
            <div class="price">Gr√°tis (Portal SEFAZ)</div>
          </div>
        </div>

        <!-- Focus NFe Config -->
        <div id="config-focus_nfe" class="provider-config">
          <div class="alert info">
            <span class="icon">üí°</span>
            <div class="content">
              <div class="title">Focus NFe</div>
              <div class="text">
                Crie sua conta em <a href="https://focusnfe.com.br" target="_blank">focusnfe.com.br</a> 
                e obtenha seu token de API. Voc√™ paga apenas por nota emitida (~R$ 0,12).
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Token de API Focus NFe</label>
            <input type="password" id="focusToken" placeholder="Cole aqui seu token da Focus NFe">
            <small>Encontre em: Focus NFe ‚Üí Configura√ß√µes ‚Üí API ‚Üí Token</small>
          </div>
        </div>

        <!-- NFe.io Config -->
        <div id="config-nfe_io" class="provider-config" style="display:none">
          <div class="alert info">
            <span class="icon">üí°</span>
            <div class="content">
              <div class="title">NFe.io</div>
              <div class="text">
                Crie sua conta em <a href="https://nfe.io" target="_blank">nfe.io</a> 
                e obtenha suas credenciais de API.
              </div>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>API Key</label>
              <input type="password" id="nfeioApiKey" placeholder="Sua API Key">
            </div>
            <div class="form-group">
              <label>Company ID</label>
              <input type="text" id="nfeioCompanyId" placeholder="ID da empresa no NFe.io">
            </div>
          </div>
        </div>

        <!-- eNotas Config -->
        <div id="config-enotas" class="provider-config" style="display:none">
          <div class="alert info">
            <span class="icon">üí°</span>
            <div class="content">
              <div class="title">eNotas</div>
              <div class="text">
                Crie sua conta em <a href="https://enotas.com.br" target="_blank">enotas.com.br</a>.
                Planos a partir de R$ 49/m√™s com notas ilimitadas.
              </div>
            </div>
          </div>
          <div class="form-grid">
            <div class="form-group">
              <label>API Key</label>
              <input type="password" id="enotasApiKey" placeholder="Sua API Key do eNotas">
            </div>
            <div class="form-group">
              <label>ID da Empresa</label>
              <input type="text" id="enotasEmpresaId" placeholder="ID da empresa no eNotas">
            </div>
          </div>
        </div>

        <!-- Manual -->
        <div id="config-manual" class="provider-config" style="display:none">
          <div class="alert warning">
            <span class="icon">‚úã</span>
            <div class="content">
              <div class="title">Emiss√£o Manual</div>
              <div class="text">
                Voc√™ emitir√° as notas manualmente pelo portal da SEFAZ-SP.<br>
                O sistema vai gerar os dados formatados para voc√™ copiar e colar.
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Ambiente</label>
          <select id="ambiente">
            <option value="homologacao">üß™ Homologa√ß√£o (Testes)</option>
            <option value="producao">üöÄ Produ√ß√£o (Notas Reais)</option>
          </select>
          <small>Use Homologa√ß√£o para testar. Mude para Produ√ß√£o quando estiver tudo certo.</small>
        </div>
      </div>
    </div>

    <!-- Tab: Empresa -->
    <div id="tab-empresa" class="tab-content">
      <div class="section">
        <div class="section-header">
          <span class="icon">üè¢</span>
          <div>
            <h2>Dados da Empresa</h2>
            <p>Informa√ß√µes que aparecer√£o na NF-e</p>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>CNPJ</label>
            <input type="text" id="cnpj" placeholder="00.000.000/0000-00" maxlength="18">
          </div>
          <div class="form-group">
            <label>Inscri√ß√£o Estadual</label>
            <input type="text" id="inscricaoEstadual" placeholder="000.000.000.000">
            <small>Deixe em branco se for ISENTO</small>
          </div>
          <div class="form-group full">
            <label>Raz√£o Social</label>
            <input type="text" id="razaoSocial" placeholder="Nome completo da empresa">
          </div>
          <div class="form-group full">
            <label>Nome Fantasia</label>
            <input type="text" id="nomeFantasia" placeholder="MegaClean Distribuidora">
          </div>
        </div>

        <h3 style="margin: 24px 0 16px; font-size: 16px;">üìç Endere√ßo</h3>
        
        <div class="form-grid">
          <div class="form-group" style="grid-column: span 2;">
            <label>Logradouro</label>
            <input type="text" id="logradouro" placeholder="Rua, Avenida...">
          </div>
          <div class="form-group">
            <label>N√∫mero</label>
            <input type="text" id="numero" placeholder="123">
          </div>
          <div class="form-group">
            <label>Complemento</label>
            <input type="text" id="complemento" placeholder="Sala, Bloco...">
          </div>
          <div class="form-group">
            <label>Bairro</label>
            <input type="text" id="bairro" placeholder="Centro">
          </div>
          <div class="form-group">
            <label>Cidade</label>
            <input type="text" id="cidade" placeholder="Sorocaba">
          </div>
          <div class="form-group">
            <label>UF</label>
            <select id="uf">
              <option value="SP">SP - S√£o Paulo</option>
              <option value="RJ">RJ - Rio de Janeiro</option>
              <option value="MG">MG - Minas Gerais</option>
              <option value="PR">PR - Paran√°</option>
              <option value="SC">SC - Santa Catarina</option>
              <option value="RS">RS - Rio Grande do Sul</option>
            </select>
          </div>
          <div class="form-group">
            <label>CEP</label>
            <input type="text" id="cep" placeholder="00000-000" maxlength="9">
          </div>
          <div class="form-group">
            <label>C√≥d. Munic√≠pio (IBGE)</label>
            <input type="text" id="codigoMunicipio" placeholder="3552205">
            <small>Sorocaba = 3552205</small>
          </div>
        </div>

        <h3 style="margin: 24px 0 16px; font-size: 16px;">üìû Contato</h3>
        
        <div class="form-grid">
          <div class="form-group">
            <label>Telefone</label>
            <input type="text" id="telefone" placeholder="(15) 98828-3792">
          </div>
          <div class="form-group">
            <label>E-mail</label>
            <input type="email" id="email" placeholder="megacleandistribuidoraa@gmail.com">
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Certificado -->
    <div id="tab-certificado" class="tab-content">
      <div class="section">
        <div class="section-header">
          <span class="icon">üîê</span>
          <div>
            <h2>Certificado Digital</h2>
            <p>Upload do certificado A1 (.pfx ou .p12)</p>
          </div>
        </div>

        <div class="alert warning">
          <span class="icon">‚ö†Ô∏è</span>
          <div class="content">
            <div class="title">Importante</div>
            <div class="text">
              O certificado digital √© obrigat√≥rio para emitir NF-e.<br>
              Compre em certificadoras autorizadas (Serasa, Certisign, Valid, etc).<br>
              <strong>Custo m√©dio: R$ 150-200/ano (e-CNPJ A1)</strong>
            </div>
          </div>
        </div>

        <div class="file-upload" onclick="document.getElementById('certificadoFile').click()">
          <div class="icon">üìÅ</div>
          <div class="text">Clique para enviar o certificado (.pfx ou .p12)</div>
          <div class="filename" id="certificadoNome"></div>
          <input type="file" id="certificadoFile" accept=".pfx,.p12" onchange="handleCertificado(this)">
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label>Senha do Certificado</label>
          <input type="password" id="senhaCertificado" placeholder="Digite a senha do certificado">
        </div>

        <div id="certificadoInfo" style="display:none; margin-top: 20px;">
          <div class="alert success">
            <span class="icon">‚úÖ</span>
            <div class="content">
              <div class="title">Certificado carregado</div>
              <div class="text" id="certificadoDetalhes"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Fiscal -->
    <div id="tab-fiscal" class="tab-content">
      <div class="section">
        <div class="section-header">
          <span class="icon">üìã</span>
          <div>
            <h2>Configura√ß√µes Fiscais</h2>
            <p>Par√¢metros para emiss√£o das notas</p>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label>Regime Tribut√°rio</label>
            <select id="regimeTributario">
              <option value="1">1 - Simples Nacional (MEI)</option>
              <option value="2">2 - Simples Nacional - Excesso</option>
              <option value="3">3 - Regime Normal</option>
            </select>
          </div>
          <div class="form-group">
            <label>CRT (C√≥digo Regime Tribut√°rio)</label>
            <select id="crt">
              <option value="1">1 - Simples Nacional</option>
              <option value="2">2 - Simples Nacional - Excesso</option>
              <option value="3">3 - Regime Normal</option>
            </select>
          </div>
          <div class="form-group">
            <label>CFOP Padr√£o</label>
            <select id="cfopPadrao">
              <option value="5102">5102 - Venda merc. adq. terceiros (dentro SP)</option>
              <option value="5101">5101 - Venda produ√ß√£o pr√≥pria (dentro SP)</option>
              <option value="6102">6102 - Venda merc. adq. terceiros (fora SP)</option>
              <option value="6101">6101 - Venda produ√ß√£o pr√≥pria (fora SP)</option>
            </select>
            <small>Use 5102 para revenda de produtos dentro de SP</small>
          </div>
          <div class="form-group">
            <label>S√©rie da NF-e</label>
            <input type="number" id="serieNfe" value="1" min="1">
          </div>
          <div class="form-group">
            <label>Pr√≥ximo N√∫mero NF-e</label>
            <input type="number" id="proximoNumeroNfe" value="1" min="1">
            <small>N√∫mero da pr√≥xima nota a ser emitida</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions">
      <button class="btn btn-primary" onclick="salvarConfig()">
        üíæ Salvar Configura√ß√µes
      </button>
      <button class="btn btn-warning" onclick="testarConexao()">
        üß™ Testar Conex√£o
      </button>
      <button class="btn btn-ghost" onclick="window.location.href='/admin.html'">
        Cancelar
      </button>
    </div>
  </div>

  <script>
let config = {};
let provedorSelecionado = 'focus_nfe';
let certificadoBase64 = '';

// ============================================
// TABS
// ============================================
function mudarTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  
  document.querySelector(`[onclick="mudarTab('${tab}')"]`).classList.add('active');
  document.getElementById(`tab-${tab}`).classList.add('active');
}

// ============================================
// PROVEDOR
// ============================================
function selecionarProvedor(provedor) {
  provedorSelecionado = provedor;
  
  // Atualizar visual
  document.querySelectorAll('.provider-option').forEach(opt => opt.classList.remove('active'));
  document.querySelector(`[data-provider="${provedor}"]`).classList.add('active');
  
  // Mostrar config correspondente
  document.querySelectorAll('.provider-config').forEach(cfg => cfg.style.display = 'none');
  document.getElementById(`config-${provedor}`).style.display = 'block';
}

// ============================================
// CERTIFICADO
// ============================================
function handleCertificado(input) {
  const file = input.files[0];
  if (!file) return;
  
  document.getElementById('certificadoNome').textContent = file.name;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    certificadoBase64 = e.target.result.split(',')[1]; // Remove o prefixo data:...
    
    document.getElementById('certificadoInfo').style.display = 'block';
    document.getElementById('certificadoDetalhes').textContent = 
      `Arquivo: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
  };
  reader.readAsDataURL(file);
}

// ============================================
// CARREGAR CONFIG
// ============================================
async function carregarConfig() {
  try {
    const res = await fetch('/api/config-nfe');
    if (res.ok) {
      config = await res.json();
      preencherFormulario(config);
      atualizarStatus(config);
    }
  } catch (e) {
    console.error('Erro ao carregar config:', e);
  }
}

function preencherFormulario(cfg) {
  if (cfg.provedor) {
    selecionarProvedor(cfg.provedor);
  }
  
  // Preencher campos
  const campos = [
    'focusToken', 'nfeioApiKey', 'nfeioCompanyId', 'enotasApiKey', 'enotasEmpresaId',
    'ambiente', 'cnpj', 'inscricaoEstadual', 'razaoSocial', 'nomeFantasia',
    'logradouro', 'numero', 'complemento', 'bairro', 'cidade', 'uf', 'cep',
    'codigoMunicipio', 'telefone', 'email', 'regimeTributario', 'crt',
    'cfopPadrao', 'serieNfe', 'proximoNumeroNfe', 'senhaCertificado'
  ];
  
  campos.forEach(campo => {
    const el = document.getElementById(campo);
    if (el && cfg[campo] !== undefined) {
      el.value = cfg[campo];
    }
  });
  
  // Certificado
  if (cfg.certificadoBase64) {
    certificadoBase64 = cfg.certificadoBase64;
    document.getElementById('certificadoNome').textContent = '‚úÖ Certificado j√° carregado';
    document.getElementById('certificadoInfo').style.display = 'block';
    document.getElementById('certificadoDetalhes').textContent = 'Certificado salvo no sistema';
  }
}

function atualizarStatus(cfg) {
  const card = document.getElementById('status-card');
  
  if (cfg.configurado) {
    card.className = 'status-card success';
    card.innerHTML = `
      <div class="status-icon">‚úÖ</div>
      <div class="status-info">
        <h3>NF-e Configurada</h3>
        <p>Ambiente: ${cfg.ambiente === 'producao' ? 'üöÄ Produ√ß√£o' : 'üß™ Homologa√ß√£o'} | Provedor: ${cfg.provedor}</p>
      </div>
    `;
  } else {
    card.className = 'status-card warning';
    card.innerHTML = `
      <div class="status-icon">‚ö†Ô∏è</div>
      <div class="status-info">
        <h3>NF-e n√£o configurada</h3>
        <p>Preencha os dados abaixo para ativar a emiss√£o de notas fiscais</p>
      </div>
    `;
  }
}

// ============================================
// SALVAR CONFIG
// ============================================
async function salvarConfig() {
  const dados = {
    provedor: provedorSelecionado,
    focusToken: document.getElementById('focusToken').value,
    nfeioApiKey: document.getElementById('nfeioApiKey').value,
    nfeioCompanyId: document.getElementById('nfeioCompanyId').value,
    enotasApiKey: document.getElementById('enotasApiKey').value,
    enotasEmpresaId: document.getElementById('enotasEmpresaId').value,
    ambiente: document.getElementById('ambiente').value,
    cnpj: document.getElementById('cnpj').value,
    inscricaoEstadual: document.getElementById('inscricaoEstadual').value,
    razaoSocial: document.getElementById('razaoSocial').value,
    nomeFantasia: document.getElementById('nomeFantasia').value,
    logradouro: document.getElementById('logradouro').value,
    numero: document.getElementById('numero').value,
    complemento: document.getElementById('complemento').value,
    bairro: document.getElementById('bairro').value,
    cidade: document.getElementById('cidade').value,
    uf: document.getElementById('uf').value,
    cep: document.getElementById('cep').value,
    codigoMunicipio: document.getElementById('codigoMunicipio').value,
    telefone: document.getElementById('telefone').value,
    email: document.getElementById('email').value,
    regimeTributario: parseInt(document.getElementById('regimeTributario').value),
    crt: parseInt(document.getElementById('crt').value),
    cfopPadrao: document.getElementById('cfopPadrao').value,
    serieNfe: parseInt(document.getElementById('serieNfe').value),
    proximoNumeroNfe: parseInt(document.getElementById('proximoNumeroNfe').value),
    senhaCertificado: document.getElementById('senhaCertificado').value,
    certificadoBase64: certificadoBase64,
    configurado: true
  };
  
  try {
    const res = await fetch('/api/config-nfe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(dados)
    });
    
    if (res.ok) {
      showToast('‚úÖ Configura√ß√µes salvas com sucesso!', 'success');
      config = dados;
      atualizarStatus(config);
    } else {
      throw new Error('Erro ao salvar');
    }
  } catch (e) {
    showToast('‚ùå Erro ao salvar configura√ß√µes', 'error');
  }
}

// ============================================
// TESTAR CONEX√ÉO
// ============================================
async function testarConexao() {
  showToast('üîÑ Testando conex√£o...', 'info');
  
  try {
    const res = await fetch('/api/config-nfe/testar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ provedor: provedorSelecionado })
    });
    
    const data = await res.json();
    
    if (data.sucesso) {
      showToast('‚úÖ Conex√£o OK! API respondendo corretamente.', 'success');
    } else {
      showToast('‚ùå Falha: ' + (data.erro || 'Erro desconhecido'), 'error');
    }
  } catch (e) {
    showToast('‚ùå Erro ao testar conex√£o', 'error');
  }
}

// ============================================
// TOAST
// ============================================
function showToast(msg, type = 'info') {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  document.body.appendChild(toast);
  
  setTimeout(() => toast.remove(), 4000);
}

// ============================================
// M√ÅSCARAS
// ============================================
document.getElementById('cnpj').addEventListener('input', function(e) {
  let v = e.target.value.replace(/\D/g, '');
  v = v.replace(/^(\d{2})(\d)/, '$1.$2');
  v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
  v = v.replace(/\.(\d{3})(\d)/, '.$1/$2');
  v = v.replace(/(\d{4})(\d)/, '$1-$2');
  e.target.value = v.slice(0, 18);
});

document.getElementById('cep').addEventListener('input', function(e) {
  let v = e.target.value.replace(/\D/g, '');
  v = v.replace(/^(\d{5})(\d)/, '$1-$2');
  e.target.value = v.slice(0, 9);
});

// ============================================
// INIT
// ============================================
carregarConfig();
</script>
</body>
</html>

